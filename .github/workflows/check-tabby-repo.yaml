name: Check for new Tabby releases

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest Tabby release
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: latestRelease } = await github.rest.repos.getLatestRelease({
              owner: 'TabbyML',
              repo: 'tabby'
            });

            const latestVersion = latestRelease.tag_name;
            console.log(`Latest Tabby version: ${latestVersion}`);

            // Check if we've already built this version
            try {
              const { data: ourReleases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const alreadyBuilt = ourReleases.some(r => r.tag_name === latestVersion);
              
              if (alreadyBuilt) {
                console.log(`Version ${latestVersion} already built`);
                core.setOutput('should_build', 'false');
              } else {
                console.log(`New version ${latestVersion} detected!`);
                core.setOutput('should_build', 'true');
                core.setOutput('version', latestVersion);
              }
            } catch (error) {
              console.log('No releases found in our repo, building first release');
              core.setOutput('should_build', 'true');
              core.setOutput('version', latestVersion);
            }

      - name: Trigger build workflow
        if: steps.check.outputs.should_build == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              ref: 'main',
              inputs: {
                tabby_version: '${{ steps.check.outputs.version }}'
              }
            });

      - name: Create release tag
        if: steps.check.outputs.should_build == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.check.outputs.version }}';
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${version}`,
              sha: context.sha
            });
